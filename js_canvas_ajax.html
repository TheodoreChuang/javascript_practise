<!DOCTYPE html>
<html lang="en">
<head>
  <title>Canvas AJAX</title>
  <script src="jquery.min.js" type="text/javascript"></script>
</head>
<body>

<input id="newTweet" />
<button id="newTweetButton">+tweet</button>

<ul id="tweets"></ul>

<script>  

let tweetUl = document.getElementById("tweets");

// TODO - XHR
// function getUserData() {
//     console.log("Starting XHR");

//     let request = new XMLHttpRequest();  // XHR

//     request.open('GET', 'https://randomuser.me/api', true);

//     request.onload = () => {
//       if (request.status >= 200 && request.status < 400) {
//         console.log(request.responseText);
//       } else {
//         console.log("Error");
//         console.log(request);
//       }
//     }

//     request.onerror = () => {
//       console.log("Connection error");
//     }

//     request.send();
//   }

function displayTweets(tweets) {
  tweets.forEach(function(tweet) {
    let tweetLi = document.createElement("li")
    tweetLi.textContent = tweet.message;
    tweetUl.appendChild(tweetLi);
  })
}

// --------- Display All with jQuery ---------   

function jqueryAllTweet(callback) {
  $.ajax({
    url: "http://localhost:3000/tweets.json",
    type: "GET",
    success: (data) => {
      console.log(data);
      callback(data)
    },
    error: (error) => {
      console.log(error);
    }
  })
}

// jqueryAllTweet(displayTweets);

// --------- Display All with Fetch ---------   

function fetchAllTweets() {
  fetch("http://localhost:3000/tweets.json")
    .then(response => response.json())
    .then(json => displayTweets(json))
    .catch(error => console.log(error));
}

fetchAllTweets()


// --------- Post New Tweet ---------   

let newTweet = document.getElementById('newTweet')
let newTweetButton = document.getElementById('newTweetButton')

newTweetButton.addEventListener("click", postNewTweet);

// FIXME - 400
// function postNewTweet() {
//   $.ajax({
//     url: "http://localhost:3000/tweets.json",
//     type: "POST",
//     data: { tweets: { message: newTweet }},
//     success: (tweet) => {
//       console.log(`Success: ${tweet}`);
//     },
//     error: (error) => {
//       console.log(error);
//     }
//   })
// }

// Works only if directly in Rails App, Rails security issues
function postNewTweet() {
    let url = "http://localhost:3000/tweets.json";
    let data = { tweet: { message: `${newTweet.value}` } };

    fetch(url, {
    method: "POST",
    headers: {
        "Content-Type": "application/json; charset=utf-8"
    },
    body: JSON.stringify(data),
    })
    // .then(response => console.log(response))
    .then(response => response.json())
    .then(json => console.log(json.value))
    .catch(error => console.log(error));
}

</script>    
</body>
</html>